---
title: "Exploratory Data Analysis"
---

You have a new dataset and it's time to dig in. 
You may have some information about how the data was collected (or not!), but you almost certainly don't already know what's *in* the data - what artifacts, data entry errors, missing data, and outliers may show up.
Exploratory Data Analysis, or EDA, is like an exploratory hike through unknown territory. 
You may have prepared ahead of time - you may have a map, hiking boots, and so on, but you cannot predict what wildlife you will see or what obstacles you might encounter.



Throughout this section, we'll use the `palmerpenguins` data to illustrate different ways to explore data.

::: panel-tabset

## R

```{r}
# Run if you don't have the package installed
# install.packages("palmerpenguins")
library(palmerpenguins)
head(penguins)
```

## Python

```{python}
from palmerpenguins import load_penguins
penguins = load_penguins()
penguins.head()
```

:::





# Examining the Data

Roger Peng's e-book "Exploratory Data Analysis with R" contains a [checklist](https://bookdown.org/rdpeng/exdata/exploratory-data-analysis-checklist.html) for EDA that is a useful starting point. 

This checklist covers mostly numerical summaries, but these numerical summaries can be incredibly useful for getting familiar with the data before proceeding with a graphical exploration. 

1. Formulate your question - come up with at least one question to guide your analysis. This prevents you from trying to explore too many paths at once. (You don't necessarily need to stick to this path if you find another interesting one, though.)

2. Read in your data

3. Check the packaging - look at the number of rows and columns and ensure they match your expectations.

4. Examine the structure of your data (e.g. using `str()` in R or `DataFrame.info()` in pandas)

5. Look at the top and the bottom of your data using functions like `head()` and `tail()`

6. Check your "n"s - examine counts of data by relevant variables, like location, participant, time to ensure the data matches your expectations.

7. Validate with at least one external data source - check that the observations in your data fall within an acceptable range defined by some outside data source.

8. Try the easy solution first - get a simple answer to your question with a quick plot or table

9. Challenge your solution - spend a bit more time answering your question by e.g. summarizing your data across a relevant dimension or examining the effect of important covariates.

10. Follow up - do you have the right data to answer your question? Do you need additional data? Do you need to adjust your question?


# Numerical EDA

It is often good to calculate some basic summary statistics for each variable, along with the assessments above and the graphical summaries we'll focus on in this section.

::: panel-tabset

## R

The `skimr` package in R produces very visually appealing numerical summaries.

```{r}
library(skimr)
skim(penguins)
```

## Python

The `skimpy` package in python is modeled on the `skimr` R package, but somehow has a much better name. 

```{python}
from skimpy import skim
skim(penguins)
```

:::


# Graphical EDA

When examining a data set, it is often useful to start out by examining single variables. 
We often care about distributions of data, both for getting to know the dataset and for considering modeling possibilities once we transition to confirmatory data analysis. 

The following chunks load in the graphics packages we'll use for the rest of this section.

::: panel-tabset

## R

```{r}
library(ggplot2)
```

## Python

```{python}
import seaborn as sns 
import seaborn.objects as so
import matplotlib.pyplot as plt
```

:::

## One-dimensional summaries

There are several basic options for distribution assessment:

- Boxplots (numerical data) - visually simple graphical five-number summaries
- Histograms (numerical data) - show full distribution of the data, useful for assessing skewness, etc.
- Density plot (numerical data) - continuous version of histogram
- Barplots (categorical data) - categorical equivalent of histogram.

It is often common to initially make these plots for one variable and then to begin to explore conditional distributions by drawing multiple plots for different values of a different variable.

The following examples show exploratory plots for the `palmerpenguins` data. 

### Boxplots

::: panel-tabset

#### R

```{r}
ggplot(penguins) + geom_boxplot(aes(y = body_mass_g))
ggplot(penguins) + geom_boxplot(aes(x = sex, y = body_mass_g))
ggplot(penguins) + geom_boxplot(aes(x = species, y = body_mass_g))
```


#### Python

```{python}
sns.boxplot(data = penguins, y = "body_mass_g")
plt.show()
```

```{python}
#| echo: false
plt.close()
```

```{python}
sns.boxplot(data = penguins, x = "sex", y = "body_mass_g")
plt.show()
```

```{python}
#| echo: false
plt.close()
```

```{python}
sns.boxplot(data = penguins, x = "species", y = "body_mass_g")
plt.show()
```

```{python}
#| echo: false
plt.close()
```

:::

### Histograms

::: panel-tabset

#### R

```{r}
ggplot(penguins) + 
  geom_histogram(aes(x = body_mass_g))

ggplot(penguins) + 
  geom_histogram(aes(x = body_mass_g, fill = sex), 
                 alpha = .5, position = "identity")

ggplot(penguins) + 
  geom_histogram(aes(x = body_mass_g, fill = species), 
                 alpha = .5, position = "identity")
```


#### Python

```{python}
(
  so.Plot(penguins, x = "body_mass_g")
    .add(so.Bars(), so.Hist(bins=30))
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "body_mass_g", color = "sex")
    .add(so.Bars(alpha=.5), so.Hist(bins=30))
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "body_mass_g", color = "species")
    .add(so.Bars(alpha=.5), so.Hist(bins=30))
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

:::

### Density Plots


::: panel-tabset

#### R

```{r}
ggplot(penguins) + 
  geom_density(aes(x = body_mass_g))

ggplot(penguins) + 
  geom_density(aes(x = body_mass_g, fill = sex), 
               alpha = .5)

ggplot(penguins) + 
  geom_density(aes(x = body_mass_g, fill = species), 
               alpha = .5)
```


#### Python

```{python}
so.Plot(penguins, x = "body_mass_g").add(so.Area(), so.KDE()).show()
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "body_mass_g", color = "sex")
    .add(so.Area(), so.KDE(common_norm=False))
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "body_mass_g", color = "species")
    .add(so.Area(), so.KDE(common_norm=False))
    .show()
)

```

```{python}
#| echo: false
plt.close()
```

:::

### Bar Plots


::: panel-tabset

#### R

```{r}
ggplot(penguins) + 
  geom_bar(aes(x = species))

ggplot(penguins) + 
  geom_bar(aes(x = species, fill = sex), 
           position = "dodge")

ggplot(penguins) + 
  geom_bar(aes(x = species, fill = island))
```


#### Python

```{python}
(
  so.Plot(penguins, x = "species")
    .add(so.Bar(), so.Count())
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "species", color = "sex")
    .add(so.Bar(), so.Count(), so.Dodge())
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "species", color = "island")
    .add(so.Bar(), so.Count(), so.Stack())
    .show()
)
```
```{python}
#| echo: false
plt.close()
```

:::


## Two-dimensional summaries

Some of the one-dimensional summaries discussed above are easily modified into two dimensional summaries by coloring by or faceting by another variable. 
Other two-dimensional summaries require different types of plots: for instance, scatter plots, which show two numerical variables and can be modified to use color, shape, and facets to include even more information. 

### Scatterplots

::: panel-tabset

#### R

```{r}
ggplot(penguins, 
       aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point() 

ggplot(penguins, 
       aes(x = bill_length_mm, y = bill_depth_mm, 
           color = species)) +
  geom_point() 

ggplot(penguins, 
       aes(x = bill_length_mm, y = bill_depth_mm, 
           color = species)) +
  geom_point() +
  facet_wrap(~year)
```

#### Python

```{python}
(
  so.Plot(penguins, x = "bill_length_mm", y = "bill_depth_mm")
    .add(so.Dot())
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "bill_length_mm", y = "bill_depth_mm", color = "species")
    .add(so.Dot())
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

```{python}
(
  so.Plot(penguins, x = "bill_length_mm", y = "bill_depth_mm", color = "species")
    .facet("year")
    .add(so.Dot())
    .show()
)
```

```{python}
#| echo: false
plt.close()
```

:::

### Scatter plot Matrices

Sometimes, we want to examine conditional relationships between many different variables at a time - for instance, to identify highly correlated variables when considering fitting a linear model.
Scatter plot matrices allow us to examine relationships between many sets of two variables at once.

::: panel-tabset

#### R

```{r, message = F, warning = F}
#| fig-width: 8
#| fig-height: 8
#| out-width: 100%

library(GGally)

ggpairs(penguins, columns = 3:6, aes(color = species))
```

#### Python

```{python}
#| fig-width: 8
#| fig-height: 8
#| out-width: 100%
penguin_measures = penguins.drop("year", axis = 1)
sns.pairplot(penguin_measures, hue = "species")
```
```{python}
#| echo: false
plt.close()
```

:::

# Analyzing An Example Dataset

An exploration of an interesting [dataset](../data/new_data.csv) showing the value of different types of plots for understanding your data.

```{r new-data-setup}
#| eval: false
#| include: false

# Create new data
library(datasauRus)
convert_groups <- tibble(orig = unique(datasaurus_dozen$dataset), new = LETTERS[1:13])

add_missing <- function(data, n_na_v1, n_na_v2) {
  missing_v1 <- slice_sample(data, n = n_na_v1) |>
    mutate(V1 = NA)
  missing_v2 <- slice_sample(data, n = n_na_v2) |>
    mutate(V2 = NA)
  return(bind_rows(data, missing_v1, missing_v2))
}

set.seed(23409234)
new_data <- datasaurus_dozen |>
  set_names(c("group", "V1", "V2")) |> 
  left_join(convert_groups, by = c("group" = "orig")) |>
  select(-group) |>
  rename(group = new) |>
  select(group, V1, V2) |>
  nest(data = -group) |>
  mutate(n_na_v1 = sample(1:20, n(), replace = T),
         n_na_v2 = sample(1:20, n(), replace = T)) |>
  mutate(data = purrr::pmap(list(data, n_na_v1, n_na_v2), add_missing)) |>
  select(-starts_with("n_na_")) |>
  unnest(data) |>
  slice_sample(prop = 1, replace = F)

write.csv(new_data, "../data/new_data.csv", row.names = F)
```

## Setup

::: panel-tabset

### R

```{r}
# Data manipulation
library(tibble) # data frame++
library(dplyr) # wrangling
library(tidyr) # reshaping
library(magrittr) # pipes
library(forcats) # factors

# Graphics
library(ggplot2)
theme_set(theme_bw())
```

### Python

```{python}
# Data manipulation
import pandas as pd
import numpy as np

# Graphics
import matplotlib.pyplot as plt
import seaborn as sns
import seaborn.objects as so
```

:::

## Numerical EDA

::: panel-tabset

### R

```{r}
library(skimr)
new_data <- read.csv("../data/new_data.csv")
skim(new_data)
```

### Python

```{python}
from skimpy import skim
new_data = pd.read_csv("../data/new_data.csv")
skim(new_data)
```

:::

## Graphical EDA

### Missing Data

::: panel-tabset

#### R

```{r}
library(visdat)

vis_dat(new_data) + 
  # Make color values a bit more colorblind friendly
  scale_fill_manual(values = c("#d73027", "#4575b4"), 
                    na.value = "#AAAAAA")
```

#### Python

```{python}
import missingno as msno
msno.matrix(new_data, label_rotation = 0)
plt.show()
```
```{python}
#| echo: false
plt.close()
```

:::

### Single Variable Distributions

::: panel-tabset

#### R

```{r}
new_data |> 
  pivot_longer(-group, names_to = "var", values_to = "value") |>
  ggplot() + 
    geom_boxplot(aes(x = value)) + 
    facet_grid(var~.)

new_data |>
  mutate(missing_val = is.na(V1) | is.na(V2)) |>
  mutate(missing_val = c("NO", "YES")[missing_val+1] |>
                       fct_relevel("YES")) |>
  ggplot() + 
  geom_bar(aes(x = group, fill = missing_val))
```

#### Python

```{python}
new_data = new_data.sort_values(['group', 'V1', 'V2'])
new_data_long = pd.melt(new_data, id_vars = 'group', value_vars = ['V1', 'V2'], var_name = 'var')
sns.catplot(data = new_data_long, x = 'value', y = 'var', kind = 'box')
plt.show()
```
```{python}
#| echo: false
plt.close()
```

```{python}
new_data['missing_val'] = pd.isna(new_data.V1) | pd.isna(new_data.V2)
so.Plot(new_data, x = 'group', color = 'missing_val').add(so.Bar(), so.Hist(), so.Stack()).show()
```
```{python}
#| echo: false
plt.close()
```



:::

### Conditional Distributions

::: panel-tabset

#### R

```{r}
new_data |>
  pivot_longer(-group, names_to = "var", values_to = "value") |>
  ggplot() + 
    geom_boxplot(aes(x = group, y = value)) + 
    facet_grid(var~.)
```

#### Python

```{python}
sns.catplot(data = new_data_long, x = 'group', y = 'value', row = 'var', kind = "box")
plt.show()
```
```{python}
#| echo: false
plt.close()
```

:::

### Bivariate Distributions

::: panel-tabset

#### R

```{r}
library(naniar)
new_data |>
  ggplot(aes(x = V1, y = V2)) + 
  geom_miss_point() + 
  ggtitle(paste(
    "naniar package:",
    "Include missing vars")) + 
  theme(legend.position = 
          "bottom")
```

```{r}
new_data |>
  ggplot(aes(x = V1, y = V2)) + geom_miss_point(size = .6) + 
  facet_wrap(~group, nrow = 2) + 
  ggtitle("naniar package: Include missing variables") + 
  theme(legend.position = c(1, 1.25), legend.justification = c(1, 1.25),
        legend.direction = "horizontal")
```

#### Python

Python, to the best of my knowledge, doesn't have a way to show scatterplots with missing data outside the range of the non-missing data. We'll have to be content with a normal scatterplot to see the bivariate relationship.

```{python}
so.Plot(new_data, x = 'V1', y = 'V2').add(so.Dots()).show()
```
```{python}
#| echo: false
plt.close()
```

```{python}
#| fig-width: 8
#| fig-height: 3

so.Plot(new_data, x = 'V1', y = 'V2').add(so.Dots()).facet(row = 'group', wrap = 2).show()
```
```{python}
#| echo: false
plt.close()
```
:::

# Your Turn

Use the [US county-level data](../data/counties.csv)

Dataset: US County-level data, https://shorturl.at/U9KUO    
(You should be able to read this in directly from the URL)

About the data: https://github.com/evangambit/JsonOfCounties

1. Read in the data in your favorite software and pick an interesting set of variables.    
Options:    
  
  - County geometry
  - Weather (NOAA)
  - Demographics (Census)
  - Cause of death (CDC, averaged 1999-2019)
  - Employment (BLS)
  - Police Shootings (Wash Post)
  - Average Income (BEA)
  - COVID deaths (USAFacts/CDC)
  - Election Results

2. Generate some questions to explore using EDA skills.

3. Try out a few of the following techniques:
  - Tabular summaries
  - Visualizing missing data
  - Univariate distributions
  - Conditional distributions
  - Bivariate distributions
  - Scatterplot matrices